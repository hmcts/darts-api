openapi: 3.0.1

servers:
  - url: http://localhost:4550/

info:
  description: Modernised DARTS (Digital Audio Recording and Transcription Service).
  version: ${version}
  title: Modernised DARTS

paths:
  /audio-requests/v2:
    get:
      tags:
        - Audio Requests
      operationId: getYourAudio
      description: 'Audio requests for a user to view whether Current / Expired'
      parameters:
        - in: header
          name: user_id
          schema:
            type: integer
          description: The user_account primary key
          required: true
        - in: query
          name: expired
          schema:
            type: boolean
          description: if true, will retrieve expired audio requests only, if false will get current requests only
          required: true
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetAudioRequestResponse'
        '400':
          description: A required parameter is missing or an invalid.
          content:
            application/json+problem:
              schema:
                $ref: './problem.yaml'
              example:
                type: "about:blank"
                title: "Bad Request"
                status: 400
                detail: "Required parameter 'expired' is not present."
                instance: "/audio-requests"
        '401':
          description: Unauthorised Error

  /audio-requests:
    get:
      tags:
        - Audio Requests
      operationId: getYourAudioV1
      description: 'Audio requests for a user to view whether Current / Expired'
      parameters:
        - in: header
          name: user_id
          schema:
            type: integer
          description: The user_account primary key
          required: true
        - in: query
          name: expired
          schema:
            type: boolean
          description: if true, will retrieve expired audio requests only, if false will get current requests only
          required: true
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/GetAudioRequestResponseV1'
        '400':
          description: A required parameter is missing or an invalid.
          content:
            application/json+problem:
              schema:
                $ref: './problem.yaml'
              example:
                type: "about:blank"
                title: "Bad Request"
                status: 400
                detail: "Required parameter 'expired' is not present."
                instance: "/audio-requests"
        '401':
          description: Unauthorised Error
    post:
      tags:
        - Audio Requests
      summary: Users can request audio for specific cases and date/time periods
      operationId: addAudioRequest
      description: Adds a user audio request for processing
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AddAudioResponse'
        '400':
          description: 'invalid input, object invalid'
        '401':
          description: Unauthorised Error
        '409':
          description: audio request item already exists
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AudioRequestDetails'
        description: Audio Request item to add

  /audio-requests/not-accessed-count:
    get:
      tags:
        - Audio Requests
      operationId: getNonAccessedCount
      description: 'Returns count of audio requests not accessed by user provided'
      parameters:
        - in: header
          name: user_id
          schema:
            type: integer
          description: The user_account primary key
          required: true
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AudioNonAccessedResponse'
        '400':
          description: A required parameter is missing or an invalid.
          content:
            application/json+problem:
              schema:
                $ref: './problem.yaml'
              example:
                type: "about:blank"
                title: "Bad Request"
                status: 400
                detail: "Required parameter 'expired' is not present."
                instance: "/audio-requests/not-accessed-count"
        '401':
          description: Unauthorised Error

  /audio-requests/transformed_media/{transformed_media_id}:
    delete:
      tags:
        - Audio Requests
      description: 'Delete Transformed Media and Processed Audio'
      operationId: deleteTransformedMedia
      parameters:
        - in: path
          name: transformed_media_id
          schema:
            type: integer
          required: true
      responses:
        '204':
          description: Transformed Media has been deleted
        '404':
          description: Not Found Error
          content:
            application/json+problem:
              schema:
                $ref: './problem.yaml'
              example:
                type: "AUDIO_REQUESTS_103"
                title: "The requested transformed media cannot be found"
                status: 404

    patch:
      tags:
        - Audio Requests
      description: 'Update last accessed timestamp for transformed_media'
      operationId: updateTransformedMediaLastAccessedTimestamp
      parameters:
        - in: path
          name: transformed_media_id
          schema:
            type: integer
          required: true
      responses:
        '204':
          description: No Content
        '404':
          description: Not Found Error
          content:
            application/json+problem:
              schema:
                $ref: './problem.yaml'
              example:
                type: "AUDIO_REQUESTS_100"
                title: "The requested transformed media cannot be found"
                status: 404

  /audio-requests/{media_request_id}:
    delete:
      tags:
        - Audio Requests
      description: 'Delete Audio Request and Processed Audio'
      operationId: deleteAudioRequest
      parameters:
        - in: path
          name: media_request_id
          schema:
            type: integer
          required: true
      responses:
        '204':
          description: audio request has been deleted
        '400':
          description: Bad Request Error
          content:
            application/json+problem:
              schema:
                $ref: './problem.yaml'
              example:
                type: "AUTHORISATION_103"
                title: "Failed to check authorisation for the media request"
                status: 400
        '401':
          description: Unauthorised Error
        '403':
          description: Forbidden Error
          content:
            application/json+problem:
              schema:
                allOf:
                  - $ref: './problem.yaml'
                  - type: object
                    required:
                      - type
                    properties:
                      type:
                        $ref: '#/components/schemas/MediaRequestAuthorisation403ErrorCode'
              example:
                type: "AUTHORISATION_100"
                title: "User is not authorised for the associated courthouse"
                status: 403
        '404':
          description: Not Found Error
          content:
            application/json+problem:
              schema:
                $ref: './problem.yaml'
              example:
                type: "AUDIO_REQUESTS_100"
                title: "The requested audio request cannot be found"
                status: 404

    patch:
      tags:
        - Audio Requests
      description: 'Update Audio Request last accessed timestamp'
      operationId: updateAudioRequestLastAccessedTimestamp
      parameters:
        - in: path
          name: media_request_id
          schema:
            type: integer
          required: true
      responses:
        '204':
          description: No Content
        '400':
          description: Bad Request Error
          content:
            application/json+problem:
              schema:
                $ref: './problem.yaml'
              example:
                type: "AUTHORISATION_103"
                title: "Failed to check authorisation for the media request"
                status: 400
        '401':
          description: Unauthorised Error
        '403':
          description: Forbidden Error
          content:
            application/json+problem:
              schema:
                allOf:
                  - $ref: './problem.yaml'
                  - type: object
                    required:
                      - type
                    properties:
                      type:
                        $ref: '#/components/schemas/MediaRequestAuthorisation403ErrorCode'
              example:
                type: "AUTHORISATION_100"
                title: "User is not authorised for the associated courthouse"
                status: 403
        '404':
          description: Not Found Error
          content:
            application/json+problem:
              schema:
                $ref: './problem.yaml'
              example:
                type: "AUDIO_REQUESTS_100"
                title: "The requested audio request cannot be found"
                status: 404

  /audio-requests/download:
    get:
      tags:
        - Audio Requests
      summary: Download audio
      operationId: download
      description: Download audio
      parameters:
        - in: query
          name: media_request_id
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: OK
          content:
            application/zip:
              schema:
                type: string
                format: binary
              example:
                type: "AUDIO_REQUESTS_102"
                title: "The audio request is not valid for this action"
                status: 400
        '401':
          description: Unauthorised Error
        '403':
          description: Forbidden Error
          content:
            application/json+problem:
              schema:
                allOf:
                  - $ref: './problem.yaml'
                  - type: object
                    required:
                      - type
                    properties:
                      type:
                        $ref: '#/components/schemas/MediaRequestAuthorisation403ErrorCode'
              example:
                type: "AUTHORISATION_100"
                title: "User is not authorised for the associated courthouse"
                status: 403
        '404':
          description: Not Found Error
          content:
            application/json+problem:
              schema:
                $ref: './problem.yaml'
              example:
                type: "AUDIO_REQUESTS_100"
                title: "The requested audio request cannot be found"
                status: 404
        '500':
          description: The requested data cannot be located
          content:
            application/json+problem:
              schema:
                $ref: './problem.yaml'
              example:
                type: "AUDIO_101"
                title: "The requested data cannot be located"
                status: 500

  /audio-requests/playback:
    get:
      tags:
        - Audio Requests
      summary: Playback audio
      operationId: playback
      description: Playback audio
      parameters:
        - in: query
          name: media_request_id
          required: true
          schema:
            type: integer
        - in: header
          name: range
          schema:
            type: string
          description: "Range header"
      responses:
        '200':
          description: OK
          content:
            audio/mpeg:
              schema:
                type: string
                format: byte
        '400':
          description: Bad Request Error
          content:
            application/json+problem:
              schema:
                $ref: './problem.yaml'
              example:
                type: "AUDIO_REQUESTS_102"
                title: "The audio request is not valid for this action"
                status: 400
        '401':
          description: Unauthorised Error
        '403':
          description: Forbidden Error
          content:
            application/json+problem:
              schema:
                allOf:
                  - $ref: './problem.yaml'
                  - type: object
                    required:
                      - type
                    properties:
                      type:
                        $ref: '#/components/schemas/MediaRequestAuthorisation403ErrorCode'
              example:
                type: "AUTHORISATION_100"
                title: "User is not authorised for the associated courthouse"
                status: 403
        '404':
          description: Not Found Error
          content:
            application/json+problem:
              schema:
                $ref: './problem.yaml'
              example:
                type: "AUDIO_REQUESTS_100"
                title: "The requested audio request cannot be found"
                status: 404
        '500':
          description: The requested data cannot be located
          content:
            application/json+problem:
              schema:
                $ref: './problem.yaml'
              example:
                type: "AUDIO_101"
                title: "The requested data cannot be located"
                status: 500

components:
  schemas:
    GetAudioRequestResponse:
      type: object
      properties:
        media_request_details:
          type: array
          items:
            $ref: '#/components/schemas/MediaRequestDetails'
        transformed_media_details:
          type: array
          items:
            $ref: '#/components/schemas/TransformedMediaDetails'

    MediaRequestDetails:
      type: object
      properties:
        media_request_id:
          type: integer
          example: 12345
        case_id:
          type: integer
          example: 123
        hearing_id:
          type: integer
          example: 456
        request_type:
          $ref: '#/components/schemas/AudioRequestType'
        case_number:
          type: string
          example: "T20200190"
        courthouse_name:
          type: string
          example: "Manchester Minshull Street"
        hearing_date:
          type: string
          format: date
          example: "2023-08-17"
        start_ts:
          type: string
          format: date-time
          example: "2023-08-21T09:00:00Z"
        end_ts:
          type: string
          format: date-time
          example: "2023-08-21T10:00:00Z"
        media_request_status:
          $ref: '#/components/schemas/MediaRequestStatus'
    TransformedMediaDetails:
      type: object
      properties:
        media_request_id:
          type: integer
          example: 12345
        transformed_media_id:
          type: integer
          example: 123
        case_id:
          type: integer
          example: 123
        hearing_id:
          type: integer
          example: 456
        request_type:
          $ref: '#/components/schemas/AudioRequestType'
        case_number:
          type: string
          example: "T20200190"
        courthouse_name:
          type: string
          example: "Manchester Minshull Street"
        hearing_date:
          type: string
          format: date
          example: "2023-08-17"
        start_ts:
          type: string
          format: date-time
          example: "2023-08-21T09:00:00Z"
        end_ts:
          type: string
          format: date-time
          example: "2023-08-21T10:00:00Z"
        transformed_media_expiry_ts:
          type: string
          format: date-time
          example: "2023-08-23T09:00:00Z"
        media_request_status:
          $ref: '#/components/schemas/MediaRequestStatus'
        transformed_media_filename:
          type: string
          example: "T20200190.zip"
        transformed_media_format:
          $ref: '#/components/schemas/AudioRequestOutputFormat'
        last_accessed_ts:
          type: string
          format: date-time
          example: "2023-08-23T09:00:00Z"

    GetAudioRequestResponseV1:
      type: object
      properties:
        media_request_id:
          type: integer
          example: 12345
        case_id:
          type: integer
          example: 123
        hearing_id:
          type: integer
          example: 456
        request_type:
          $ref: '#/components/schemas/AudioRequestType'
        case_number:
          type: string
          example: "T20200190"
        courthouse_name:
          type: string
          example: "Manchester Minshull Street"
        hearing_date:
          type: string
          format: date
          example: "2023-08-17"
        media_request_start_ts:
          type: string
          format: date-time
          example: "2023-08-21T09:00:00Z"
        media_request_end_ts:
          type: string
          format: date-time
          example: "2023-08-21T10:00:00Z"
        media_request_expiry_ts:
          type: string
          format: date-time
          example: "2023-08-23T09:00:00Z"
        media_request_status:
          $ref: '#/components/schemas/MediaRequestStatus'
        output_filename:
          type: string
          example: "T20200190.zip"
        output_format:
          $ref: '#/components/schemas/AudioRequestOutputFormat'
        last_accessed_ts:
          type: string
          format: date-time
          example: "2023-08-23T09:00:00Z"

    defendant:
      type: string
      example: Joe Bloggs

    AudioNonAccessedResponse:
      type: object
      properties:
        count:
          type: integer
          format: int64
          example: 1

    AddAudioResponse:
      type: object
      required:
        - request_id
        - case_id
        - courthouse_name
        - defendants
        - hearing_date
        - start_time
        - end_time
      properties:
        request_id:
          type: integer
          example: 1234
        case_id:
          type: integer
          example: 1
        case_number:
          type: string
          example: 'T4565443'
        courthouse_name:
          type: string
          example: "Swansea"
        defendants:
          type: array
          items:
            $ref: '#/components/schemas/defendant'
        hearing_date:
          type: string
          format: date
          example: '10-05-2023'
        start_time:
          type: string
          format: date-time
          example: '2023-05-31T09:00:00Z'
        end_time:
          type: string
          format: date-time
          example: '2023-05-31T10:00:00Z'

    AudioRequestType:
      type: string
      enum:
        - DOWNLOAD
        - PLAYBACK

    AudioRequestDetails:
      type: object
      required:
        - hearing_id
        - requestor
        - start_time
        - end_time
        - request_type
      properties:
        hearing_id:
          type: integer
          example: 12345
        requestor:
          type: integer
          example: 4656
        start_time:
          type: string
          format: date-time
          example: '2023-05-31T09:00:00Z'
        end_time:
          type: string
          format: date-time
          example: '2023-05-31T12:00:00Z'
        request_type:
          $ref: '#/components/schemas/AudioRequestType'

    MediaRequestStatus:
      type: string
      enum:
        - OPEN
        - PROCESSING
        - FAILED
        - COMPLETED
        - EXPIRED

    AudioRequestOutputFormat:
      type: string
      enum:
        - MP3
        - ZIP

    MediaRequestAuthorisation403ErrorCode:
      type: string
      enum:
        - "AUTHORISATION_100"
      x-enum-varnames: [ USER_NOT_AUTHORISED_FOR_COURTHOUSE ]
